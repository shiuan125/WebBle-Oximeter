var device=null,isMonitor=!0,spo2Dataset=[],piDataset=[],bpmDataset=[],countdownTimer=null,heartIcon=document.getElementById("heart-icon"),countdownElement=document.getElementById("countdown-timer"),resultOxiElement=document.getElementById("oximeter-result");let ChromeSamples={log:function(){var e=Array.prototype.slice.call(arguments).map(function(e){return"string"==typeof e?e:JSON.stringify(e)}).join(" ");document.querySelector("#log").textContent+=e+"\n"},clearLog:function(){document.querySelector("#log").textContent=""},setStatus:function(e){document.querySelector("#status").textContent=e},setContent:function(e){for(var t=document.querySelector("#content");t.hasChildNodes();)t.removeChild(t.lastChild);t.appendChild(e)}},log=ChromeSamples.log;function onConnectButtonClick(){navigator.bluetooth?(ChromeSamples.clearLog(),blToggleConnection()):log("Web Bluetooth API is not available in this browser!")}function onDisconnectButtonClick(){device?(log("> Disconnecting from Bluetooth Device..."),device.gatt.connected?device.gatt.disconnect():log("> Bluetooth Device is already disconnected")):log("> Bluetooth Device is not found")}function onReconnectButtonClick(){device?device.gatt.connected?log("> Bluetooth Device is already connected"):connectAndQueryData():log("> Bluetooth Device is not found")}async function blToggleConnection(){try{return device?.gatt?.connected?device.gatt.disconnect():await blConnect(),!!device?.gatt?.connected}catch(e){console.error(e)}}async function blConnect(){let e=null,t=null,r=null;switch((device=await navigator.bluetooth.requestDevice({filters:[{name:"OXY500 BT"},{name:"B4 BT"}],optionalServices:["cdeacb80-5235-4c07-8846-93a37ee6b86d","0000fff0-0000-1000-8000-00805f9b34fb"]})).addEventListener("gattserverdisconnected",onDisconnected),log(`Select ${device.name} Pairing`),device.name){case"B4 BT":e="0000fff0-0000-1000-8000-00805f9b34fb",t="0000fff1-0000-1000-8000-00805f9b34fb",r="0000fff2-0000-1000-8000-00805f9b34fb";break;case"OXY500 BT":e="cdeacb80-5235-4c07-8846-93a37ee6b86d",t="cdeacb81-5235-4c07-8846-93a37ee6b86d";break;default:return void log("未知的設備名稱，請檢查設備設定。")}try{var l=await(await device.gatt.connect()).getPrimaryService(e),n=await l.getCharacteristic(t);if(n.addEventListener("characteristicvaluechanged",function(e){"B4 BT"===device.name?bpHandleData(e):"OXY500 BT"===device.name&&oximeterHandleData(e)}),await n.startNotifications(),log(device.name+" pairing completed"),"B4 BT"===device.name){let e=await l.getCharacteristic(r);var c=new Uint8Array([77,255,0,2,12,90]),s=(log("查看時間"),await e.writeValueWithResponse(c),getHexDateTime()),u=calculateChecksum([77,255,0,8,13,parseInt(s.yearHex,16),parseInt(s.monthHex,16),parseInt(s.dayHex,16),parseInt(s.hourHex,16),parseInt(s.minuteHex,16),parseInt(s.secondHex,16)]);let t=new Uint8Array([77,255,0,8,13,parseInt(s.yearHex,16),parseInt(s.monthHex,16),parseInt(s.dayHex,16),parseInt(s.hourHex,16),parseInt(s.minuteHex,16),parseInt(s.secondHex,16),parseInt(u,16)]),n=(setTimeout(async()=>{log("修改時間"),await e.writeValueWithResponse(t)},500),new Uint8Array([77,255,0,2,11,89])),o=(setTimeout(async()=>{log("讀取設備資訊"),await e.writeValueWithResponse(n)},1e3),new Uint8Array([77,255,0,2,5,83]));setTimeout(async()=>{log("讀取設備版本"),await e.writeValueWithResponse(o)},1500);var d=calculateChecksum([77,255,0,9,0,0,0,0,0,0,0,253]);let a=new Uint8Array([77,255,0,9,0,0,0,0,0,0,0,253,parseInt(d,16)]),i=(setTimeout(async()=>{log("查詢量測記錄"),await e.writeValueWithResponse(a)},2e3),new Uint8Array([77,255,0,2,4,82]));setTimeout(async()=>{log("Disconnect CMD!"),e.writeValueWithResponse(i)},2500)}}catch(e){log("> "+e)}}function onDisconnected(){log("> Bluetooth Device disconnected"),document.getElementById("bl-icon").hidden=!0}function bpHandleData(e){let t=null,n=null,o=null,a=null;let i=null,r=null,l=null,c=null,s=null;var u=[],d=e.target.value,g=[];for(let e=0;e<d.byteLength;e++)g.push(d.getUint8(e));if(0<g.length){var[e]=g;if(77===e){if(58===g[1]?t="4G BPM":49===g[1]&&(t="3G BPM"),0===g[4]){n="Send the all history or current data to APP.";o=(g[3]-39)/10,0===g[5]&&(0==g[6]?a="BP_Single_MODE":1==g[6]?a="BP_Single_MODE + SW Afib ON":2==g[6]?a="BP_MAM_MODE":3==g[6]&&(a="BP_MAM_MODE + SW Afib ON"),times=g[7],1==g[8]?i="User1":2==g[8]?i="User2":3==g[8]&&(i="Guest"),0==g[9]?r="MAM weight":1==g[9]?r="MAM light":256==g[9]&&(r="No MAM function"));var e=10*o,p=converBpData(g.slice(42,42+e));for(let n=0;n<p.length;n++){var m=p[n][8].toString(2).padStart(8,"0").split(""),h=m[0],S=m[1],f=m[2];let e=null,t=(0==m[3]&&0==m[4]?e="BP_Single_MODE":0==m[3]&&1==m[4]?e="BP_Single_MODE+ SW AFib ON":1==m[3]&&0==m[4]?e="BP_MAM_MODE":1==m[3]&&1==m[4]&&(e="BP_MAM_MODE+SW AFib ON"),null);1==m[5]&&0==m[6]&&0==m[7]||1==m[5]&&0==m[6]&&1==m[7]?t="G-Sensor normal":1==m[5]&&1==m[6]&&0==m[7]?t="G-Sensor up":1==m[5]&&1==m[6]&&1==m[7]?t="G-Sensor down":1==m[5]&&0==m[6]&&0==m[7]?t="G-Sensor MAM up & down":0==m[5]&&(t="Without G-Sensor status"),u.push(`Systolic:${p[n][0]} Diastolic:${p[n][1]} Pulse:${p[n][2]} 20${p[n][3].toString().padStart(2,"0")}/${p[n][4].toString().padStart(2,"0")}/${p[n][5].toString().padStart(2,"0")}\
${p[n][6].toString().padStart(2,"0")}:${p[n][7].toString().padStart(2,"0")} cuffok:${h} ihb:${S} afib:${f} mode:${e} g-sensor:`+t)}}else 5===g[4]?(n="Send user ID and version data to APP.",s=""+String.fromCharCode(g[48])+String.fromCharCode(g[49])+String.fromCharCode(g[50]),console.log("age:"+g[26])):11===g[4]?(n="Send device ID and info to APP.",l=(l=`${g[6].toString(16).padStart(2,"0")}:${g[7].toString(16).padStart(2,"0")}:${g[8].toString(16).padStart(2,"0")}:${g[9].toString(16).padStart(2,"0")}:${g[10].toString(16).padStart(2,"0")}:`+g[11].toString(16).padStart(2,"0")).toUpperCase()):12===g[4]?(n="Send the device time to APP",console.log("Send the device time to APP"),0==g[5]?c="No set time in device":1==g[5]&&(c=`20${g[6].toString().padStart(2,"0")}/${g[7].toString().padStart(2,"0")}/${g[8].toString().padStart(2,"0")} ${g[9].toString().padStart(2,"0")}:${g[10].toString().padStart(2,"0")}:`+g[11].toString().padStart(2,"0"))):129===g[4]?n="BPM reply ACK, the BPM has complete the work.":145===g[4]&&(n="BPM reply NACK, the BPM has not complete the work.");log(`Device:${t} CMD:${n} ${null!=l?"Mac Address:"+l:""}${null!=o?"bpCount:"+o:""}${null!=a?"Current Mode:"+a:""}\
${""}${null!=i?"User Number:"+i:""}\
`+(null!=r?"MAM Version:"+r:"")+(null!=c?"Device Time:"+c:"")+(null!=s?"FW Version:"+s:"")),0<u.length&&u.forEach((e,t)=>{log(""+e)})}console.log(g)}}function converBpData(t){var n=[];console.log(t);for(let e=0;e<t.length;e+=10){var o=t.slice(e,e+10);n.push(o)}return console.log(n),n}function oximeterHandleData(e){var t,n,o,a,i,r,l=e.target.value,c=[];for(let e=0;e<l.byteLength;e++)c.push(l.getUint8(e));0<c.length&&([e]=c,129===e&&isMonitor?(console.log("血氧數值"+c),t=document.getElementById("spo2-value"),n=document.getElementById("bpm-value"),o=document.getElementById("pi-value"),a=127==c[2]?"--":c[2],i=255==c[1]?"--":c[1],r=0==c[3]?"--":(.1*c[3]).toFixed(1),t.innerHTML=`<p>${a}</p>`,n.innerHTML=`<p>${i}</p>`,o.innerHTML=`<p>${r}</p>`,heartIcon.classList.toggle("active",255!=c[1]),"--"!==a&&spo2Dataset.push(parseInt(a)),"--"!==i&&bpmDataset.push(parseInt(i)),"--"!==r&&piDataset.push(parseFloat(r))):130===e?console.log("血氧飽和度和脈率報警限"+c):128===e?(c.shift(),console.log(c),pushToDataQueue(c)):console.log(c))}function startCollectingData(){spo2Dataset=[],piDataset=[],bpmDataset=[];let e=30;countdownElement.innerText="倒數："+e,countdownTimer=setInterval(()=>{e--,countdownElement.innerText="倒數："+e,e<=0&&(clearInterval(countdownTimer),countdownTimer=null,countdownElement.innerText="倒數：0",calculateAverages())},1e3)}function calculateAverages(){var e=0<spo2Dataset.length?(spo2Dataset.reduce((e,t)=>e+t)/spo2Dataset.length).toFixed(1):"--",t=0<piDataset.length?(piDataset.reduce((e,t)=>e+t)/piDataset.length).toFixed(1):"--",n=0<bpmDataset.length?(bpmDataset.reduce((e,t)=>e+t)/bpmDataset.length).toFixed(1):"--";console.log(`30 秒數據收集結束。平均值： SPO2: ${e}, PI: ${t}, Pulse: `+n),isMonitor=!1,resultOxiElement.innerText=`30 秒數據收集結束。平均值： SPO2: ${e}, PI: ${t}, Pulse: `+n}function showBluetoothIcon(){document.getElementById("bl-icon").hidden=!1}function getHexDateTime(){var e=new Date,t=(console.log(e),(e.getFullYear()%100).toString(16).padStart(2,"0"));return{yearHex:t,monthHex:(e.getMonth()+1).toString(16).padStart(2,"0"),dayHex:e.getDate().toString(16).padStart(2,"0"),hourHex:e.getHours().toString(16).padStart(2,"0"),minuteHex:e.getMinutes().toString(16).padStart(2,"0"),secondHex:e.getSeconds().toString(16).padStart(2,"0")}}function calculateChecksum(e){return(e.reduce((e,t)=>e+t,0)%256).toString(16).toUpperCase().padStart(2,"0")}